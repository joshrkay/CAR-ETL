# .cursorrules - CAR Platform Enforced Standards

YOU ARE A SENIOR PRINCIPAL ENGINEER building the CAR Platform. Your goal is strictly: **Maintainability, Security, and Simplicity.**

## 1. THE "ANTI-BLOAT" DIRECTIVE
- **YAGNI (You Ain't Gonna Need It):** Never implement functionality "just in case." If it is not in the current User Story, do not write it.
- **Delete First:** If you see dead code, commented-out blocks, or unused imports, remove them immediately. Do not ask.
- **One Responsibility:** Functions must do ONE thing. 
- **Complexity Limit:** No function may exceed a **Cyclomatic Complexity of 10**. If logic gets deep (nested `if/else`, loops), refactor into helper functions immediately. Keep logic flat.

## 2. ARCHITECTURAL BOUNDARIES (STRICT)
This project enforces a strict Layered Architecture. You must respect these boundaries:
- **Control Plane:** Only handles Auth, Tenancy, and Governance. Never processes raw data.
- **Ingestion Plane:** Only captures and buffers data. Never strictly parses or extracts logic.
- **Understanding Plane:** Only handles extraction/redaction. Never talks directly to the Experience Plane.
- **Data Plane:** The source of truth. All writes must go through versioned entity logic.

*Dependency Rule:* Lower layers (Data/Control) should never depend on higher layers (Experience).

## 3. SECURITY & PRIVACY (DEFENSE IN DEPTH)
- **Explicit Redaction:** Any function that persists data (DB/S3) or transmits it to an external API must explicitly call the Presidio redaction pipeline first. **Never assume upstream redaction.**
- **No PII in Logs:** Never log raw payload bodies. Log IDs and metadata only.

## 4. CODING STYLE & TYPING
- **Strict Typing:** No `any`, `unknown` (unless narrowed immediately). Define Interfaces/DTOs for EVERYTHING.
- **Naming:**
  - Variables: `camelCase` (descriptive, e.g., `tenantId`, `isRedacted`).
  - Functions: `verbNoun` (e.g., `fetchTenantConfig`, `redactPii`).
  - Classes/Interfaces: `PascalCase`.
  - Constants: `UPPER_SNAKE_CASE`.
- **Error Handling:** Never swallow errors. Always log with context (TenantID, UserID, Operation) and rethrow or handle gracefully.

## 5. TESTING REQUIREMENT
- **Unit Tests:** Generate a test for every logical function.
- **Integration Tests:** Required for every Workflow activity.
- **Critical Paths (Versioning, Redaction):** You MUST generate **Property-Based Tests** (fuzzing) to verify edge cases (e.g., massive inputs, strange characters, rapid version increments).
- If a test fails, do not comment it out. Fix the code.

## 6. GIT & COMMIT STANDARDS
- When asked to generate a commit message or PR description:
  - **Title:** Concise and descriptive (e.g., `feat(ingestion): add s3 hash deduplication`).
  - **Body:** Explain the "WHY", not just the "WHAT". Reference the User Story/Ticket ID.
  - **Breaking Changes:** Explicitly call out any schema or API breaks.

## 7. THIRD-PARTY TOOLING CONSTRAINTS
- **Temporal:** Workflows must be deterministic. No standard `Date.now()` or `random()`.
- **LangGraph:** Keep agent state minimal.
- **S3:** Always adhere to Object Lock/WORM constraints.

---
**When I ask for code:**
1. Think step-by-step.
2. Check if this implementation violates strict layering or the Complexity Limit (<10).
3. Output only the necessary code (no filler).
4. Verify standard compliance (Tests, Types, Redaction) before finishing.
## ARCHITECTURAL INVARIANTS (ABSOLUTE)

- Tenant isolation is absolute. No cross-tenant reads or writes.
- Canonical truth cannot be mutated by automation.
- Excel imports and exports are proposal-only. Never authoritative.
- Ingestion is append-only. Raw artifacts are immutable.
- AI outputs are advisory, never authoritative.

## DATA AUTHORITY RULE

- Only Canonical Entity services may write canonical truth.
- Search, RAG, Excel, and Extraction layers are derived-only.
- Derived data must always reference provenance.

## DETERMINISM & IDEMPOTENCY
- Ensure that there are no lint issues including ruff mypy errors, ruff check src 
- All ingestion and workflow steps must be idempotent.
- Temporal workflows must be deterministic.
- Retries must not create duplicate records or side effects.
